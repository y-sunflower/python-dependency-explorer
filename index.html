<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PyPI Dependency Explorer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #000;
        color: #fff;
        min-height: 100vh;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 300;
        margin-bottom: 0.5rem;
        letter-spacing: -0.02em;
      }

      .header p {
        color: #888;
        font-size: 1.1rem;
      }

      .search-container {
        max-width: 600px;
        margin: 0 auto 3rem;
        position: relative;
      }

      #packageInput {
        width: 100%;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        background: #111;
        border: 1px solid #333;
        border-radius: 50px;
        color: #fff;
        outline: none;
        transition: all 0.3s ease;
      }

      #packageInput:focus {
        border-color: #666;
        background: #1a1a1a;
      }

      #packageInput::placeholder {
        color: #666;
      }

      .loading {
        text-align: center;
        color: #888;
        font-size: 1.1rem;
        margin: 2rem 0;
        display: none;
      }

      .error {
        text-align: center;
        color: #ff4444;
        margin: 2rem 0;
        padding: 1rem;
        background: rgba(255, 68, 68, 0.1);
        border-radius: 8px;
        display: none;
      }

      .results {
        display: none;
        margin-top: 2rem;
      }

      .stats {
        background: #111;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        border: 1px solid #222;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 300;
        color: #fff;
        display: block;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .tree-container {
        background: #111;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #222;
        overflow-x: auto;
      }

      .tree {
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.9rem;
        min-width: fit-content;
      }

      .tree-node {
        margin: 0.25rem 0;
        position: relative;
      }

      .tree-children {
        margin-left: 1.5rem;
        position: relative;
      }

      .tree-children::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 1px;
        background: #333;
      }

      .tree-node:not(:last-child)::before {
        content: "";
        position: absolute;
        left: -1.5rem;
        top: 0.7rem;
        width: 1rem;
        height: 1px;
        background: #333;
      }

      .tree-node::after {
        content: "";
        position: absolute;
        left: -1.5rem;
        top: 0;
        bottom: 0;
        width: 1px;
        background: #333;
      }

      .tree-node:last-child::after {
        height: 0.7rem;
      }

      .package-name {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        left: -0.5rem;
      }

      .package-name:hover {
        background: #1a1a1a;
      }

      .tree-node:has(.tree-children) > .package-name::before {
        content: "üì¶ ";
        margin-right: 0.3rem;
      }

      .tree-node:not(:has(.tree-children)) > .package-name::before {
        content: "üìÑ ";
        margin-right: 0.3rem;
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }

        .header h1 {
          font-size: 2rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>PyPI Dependency Explorer</h1>
        <p>Discover the dependency tree of any Python package</p>
      </div>

      <div class="search-container">
        <input
          type="text"
          id="packageInput"
          placeholder="Enter a Python package name (e.g., requests, numpy, django)..."
          autocomplete="off"
          autofocus
        />
      </div>

      <div class="loading" id="loading">üîç Analyzing dependencies...</div>

      <div class="error" id="error"></div>

      <div class="results" id="results">
        <div class="stats">
          <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated here -->
          </div>
        </div>

        <div class="tree-container">
          <div class="tree" id="tree">
            <!-- Dependency tree will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      class DependencyExplorer {
        constructor() {
          this.input = document.getElementById("packageInput");
          this.loading = document.getElementById("loading");
          this.error = document.getElementById("error");
          this.results = document.getElementById("results");
          this.statsGrid = document.getElementById("statsGrid");
          this.tree = document.getElementById("tree");

          this.initEvents();
        }

        initEvents() {
          this.input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              this.searchPackage(this.input.value.trim());
            }
          });

          // Add some debouncing for a better UX
          let timeout;
          this.input.addEventListener("input", (e) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
              const value = e.target.value.trim();
              if (value) {
                this.searchPackage(value);
              }
            }, 500);
          });
        }

        async searchPackage(packageName) {
          if (!packageName) return;

          this.showLoading();
          this.hideError();
          this.hideResults();

          try {
            const data = await this.fetchPackageData(packageName);
            this.displayResults(data);
          } catch (error) {
            this.showError(error.message);
          } finally {
            this.hideLoading();
          }
        }

        async fetchPackageData(packageName) {
          const response = await fetch(
            `https://pypi.org/pypi/${packageName}/json`
          );

          if (!response.ok) {
            throw new Error(`Package "${packageName}" not found on PyPI`);
          }

          const data = await response.json();
          const dependencies = this.extractRequiredDependencies(data);
          const tree = await this.buildDependencyTree(
            packageName,
            dependencies
          );

          return {
            package: packageName,
            tree: tree,
            stats: this.calculateStats(tree),
          };
        }

        extractRequiredDependencies(packageData) {
          const info = packageData.info;
          const requiresDist = info.requires_dist || [];

          return requiresDist
            .filter((req) => {
              // Filter out optional dependencies (those with extra markers)
              // Optional dependencies typically contain "extra ==" in the requirement string
              return !req.includes("extra ==");
            })
            .map((req) => {
              // Extract package name from requirement string
              // Remove version specifiers and environment markers
              const packageName = req
                .split(";")[0] // Remove environment markers
                .trim()
                .split(/[<>!=]/)[0] // Remove version specifiers
                .trim()
                .split(" ")[0] // Take only the first word (package name)
                .trim();

              // Handle cases where package name might have [extra] suffix
              return packageName.split("[")[0].toLowerCase();
            })
            .filter((pkg) => pkg && pkg.length > 0);
        }

        async buildDependencyTree(
          packageName,
          dependencies,
          depth = 0,
          visited = new Set()
        ) {
          if (depth > 3 || visited.has(packageName)) {
            return { name: packageName, children: [] };
          }

          visited.add(packageName);
          const children = [];

          for (const dep of dependencies) {
            try {
              const response = await fetch(`https://pypi.org/pypi/${dep}/json`);
              if (response.ok) {
                const data = await response.json();
                const childDeps = this.extractRequiredDependencies(data);
                const childTree = await this.buildDependencyTree(
                  dep,
                  childDeps,
                  depth + 1,
                  new Set(visited)
                );
                children.push(childTree);
              } else {
                children.push({ name: dep, children: [] });
              }
            } catch (error) {
              children.push({ name: dep, children: [] });
            }
          }

          return { name: packageName, children };
        }

        calculateStats(tree) {
          const allPackages = new Set();
          const countNodes = (node) => {
            allPackages.add(node.name);
            node.children.forEach(countNodes);
          };
          countNodes(tree);

          const totalDependencies = allPackages.size - 1; // Exclude root package
          const maxDepth = this.calculateMaxDepth(tree) - 1; // Exclude root

          return {
            totalDependencies,
            uniquePackages: allPackages.size,
            maxDepth,
            directDependencies: tree.children.length,
          };
        }

        calculateMaxDepth(node) {
          if (!node.children.length) return 1;
          return (
            1 +
            Math.max(
              ...node.children.map((child) => this.calculateMaxDepth(child))
            )
          );
        }

        displayResults(data) {
          this.statsGrid.innerHTML = `
                    <div class="stat-item">
                        <span class="stat-number">${data.stats.directDependencies}</span>
                        <span class="stat-label">Direct Dependencies</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${data.stats.totalDependencies}</span>
                        <span class="stat-label">Total Dependencies</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${data.stats.uniquePackages}</span>
                        <span class="stat-label">Unique Packages</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number">${data.stats.maxDepth}</span>
                        <span class="stat-label">Max Depth</span>
                    </div>
                `;

          this.tree.innerHTML = this.renderTree(data.tree);
          this.showResults();
        }

        renderTree(node) {
          const hasChildren = node.children && node.children.length > 0;

          return `
                    <div class="tree-node">
                        <div class="package-name">${node.name}</div>
                        ${
                          hasChildren
                            ? `
                            <div class="tree-children">
                                ${node.children
                                  .map((child) => this.renderTree(child))
                                  .join("")}
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;
        }

        showLoading() {
          this.loading.style.display = "block";
        }

        hideLoading() {
          this.loading.style.display = "none";
        }

        showError(message) {
          this.error.textContent = message;
          this.error.style.display = "block";
        }

        hideError() {
          this.error.style.display = "none";
        }

        showResults() {
          this.results.style.display = "block";
          this.results.classList.add("fade-in");
        }

        hideResults() {
          this.results.style.display = "none";
          this.results.classList.remove("fade-in");
        }
      }

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new DependencyExplorer();
      });

      // Add some example packages for quick testing
      const examples = ["requests", "numpy", "django", "flask", "pandas"];
      let exampleIndex = 0;

      function rotateExample() {
        const input = document.getElementById("packageInput");
        input.placeholder = `Enter a Python package name (e.g., ${examples[exampleIndex]}...)`;
        exampleIndex = (exampleIndex + 1) % examples.length;
      }

      // Rotate examples every 3 seconds
      setInterval(rotateExample, 3000);
      rotateExample(); // Initial call
    </script>
  </body>
</html>
